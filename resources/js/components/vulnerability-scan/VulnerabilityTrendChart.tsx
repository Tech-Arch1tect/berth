import { useState } from 'react';
import { cn } from '../../utils/cn';
import { theme } from '../../theme';
import { ScanTrendPoint, PerImageTrend } from '../../types/vulnerability';
import { ExclamationTriangleIcon } from '@heroicons/react/24/outline';

interface VulnerabilityTrendChartProps {
  stackTrend: ScanTrendPoint[];
  perImageTrend: PerImageTrend[];
  scopeWarning?: string;
  className?: string;
}

const CHART_HEIGHT = 160;
const CHART_PADDING = { top: 20, right: 20, bottom: 40, left: 50 };

const severityColors = {
  critical: { stroke: '#e11d48', fill: 'rgba(225, 29, 72, 0.1)' },
  high: { stroke: '#ea580c', fill: 'rgba(234, 88, 12, 0.1)' },
  medium: { stroke: '#d97706', fill: 'rgba(217, 119, 6, 0.1)' },
  low: { stroke: '#2563eb', fill: 'rgba(37, 99, 235, 0.1)' },
};

export const VulnerabilityTrendChart: React.FC<VulnerabilityTrendChartProps> = ({
  stackTrend,
  perImageTrend,
  scopeWarning,
  className,
}) => {
  const [viewMode, setViewMode] = useState<'stack' | 'per-image'>('stack');
  const [selectedImage, setSelectedImage] = useState<string | null>(
    perImageTrend.length > 0 ? perImageTrend[0].image_name : null
  );

  const displayData: ScanTrendPoint[] =
    viewMode === 'stack'
      ? stackTrend
      : perImageTrend.find((t) => t.image_name === selectedImage)?.trend_points || [];

  if (displayData.length < 2) {
    return null;
  }

  const chartWidth = 600;
  const innerWidth = chartWidth - CHART_PADDING.left - CHART_PADDING.right;
  const innerHeight = CHART_HEIGHT - CHART_PADDING.top - CHART_PADDING.bottom;

  const maxValue = Math.max(
    ...displayData.map((d) =>
      Math.max(d.summary.critical, d.summary.high, d.summary.medium, d.summary.low)
    ),
    1
  );

  const yMax = Math.ceil(maxValue / 5) * 5 || 5;

  const xScale = (index: number) =>
    CHART_PADDING.left + (index / (displayData.length - 1)) * innerWidth;
  const yScale = (value: number) => CHART_PADDING.top + innerHeight - (value / yMax) * innerHeight;

  const generatePath = (severity: 'critical' | 'high' | 'medium' | 'low') => {
    return displayData
      .map((d, i) => {
        const x = xScale(i);
        const y = yScale(d.summary[severity]);
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
      })
      .join(' ');
  };

  const yTicks = [0, yMax / 2, yMax].map((value) => ({
    value: Math.round(value),
    y: yScale(value),
  }));

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  };

  return (
    <div
      className={cn(
        'rounded-lg border p-4',
        'border-zinc-200 dark:border-zinc-800',
        'bg-white dark:bg-zinc-900',
        className
      )}
    >
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-4">
          <h3 className={cn('text-sm font-semibold', theme.text.strong)}>Vulnerability Trend</h3>

          {/* View mode toggle */}
          {perImageTrend.length > 0 && (
            <div className="flex items-center gap-1 p-0.5 rounded-lg bg-zinc-100 dark:bg-zinc-800">
              <button
                onClick={() => setViewMode('stack')}
                className={cn(
                  'px-2 py-1 text-xs rounded-md transition-colors',
                  viewMode === 'stack'
                    ? 'bg-white dark:bg-zinc-700 shadow-sm font-medium'
                    : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'
                )}
              >
                Stack
              </button>
              <button
                onClick={() => setViewMode('per-image')}
                className={cn(
                  'px-2 py-1 text-xs rounded-md transition-colors',
                  viewMode === 'per-image'
                    ? 'bg-white dark:bg-zinc-700 shadow-sm font-medium'
                    : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'
                )}
              >
                Per Image
              </button>
            </div>
          )}

          {/* Image selector */}
          {viewMode === 'per-image' && perImageTrend.length > 0 && (
            <select
              value={selectedImage || ''}
              onChange={(e) => setSelectedImage(e.target.value)}
              className={cn(
                'text-xs px-2 py-1 rounded-md border',
                'border-zinc-200 dark:border-zinc-700',
                'bg-white dark:bg-zinc-800',
                theme.text.muted
              )}
            >
              {perImageTrend.map((t) => (
                <option key={t.image_name} value={t.image_name}>
                  {t.image_name}
                </option>
              ))}
            </select>
          )}
        </div>

        {/* Legend */}
        <div className="flex items-center gap-4 text-xs">
          {Object.entries(severityColors).map(([severity, colors]) => (
            <div key={severity} className="flex items-center gap-1.5">
              <div className="w-3 h-0.5 rounded" style={{ backgroundColor: colors.stroke }} />
              <span className={theme.text.muted}>
                {severity.charAt(0).toUpperCase() + severity.slice(1)}
              </span>
            </div>
          ))}
        </div>
      </div>

      {/* Scope warning */}
      {scopeWarning && viewMode === 'per-image' && (
        <div
          className={cn(
            'flex items-start gap-2 p-2 mb-4 rounded-lg text-xs',
            'bg-amber-50 dark:bg-amber-900/20',
            'text-amber-700 dark:text-amber-300'
          )}
        >
          <ExclamationTriangleIcon className="w-4 h-4 flex-shrink-0 mt-0.5" />
          <span>{scopeWarning}</span>
        </div>
      )}

      <div className="overflow-x-auto">
        <svg
          width={chartWidth}
          height={CHART_HEIGHT}
          className="w-full"
          viewBox={`0 0 ${chartWidth} ${CHART_HEIGHT}`}
        >
          {/* Grid lines */}
          {yTicks.map(({ value, y }) => (
            <g key={value}>
              <line
                x1={CHART_PADDING.left}
                y1={y}
                x2={chartWidth - CHART_PADDING.right}
                y2={y}
                className="stroke-zinc-200 dark:stroke-zinc-700"
                strokeDasharray="4 4"
              />
              <text
                x={CHART_PADDING.left - 8}
                y={y}
                textAnchor="end"
                dominantBaseline="middle"
                className="text-xs fill-zinc-500 dark:fill-zinc-400"
              >
                {value}
              </text>
            </g>
          ))}

          {/* Lines for each severity */}
          {(
            Object.entries(severityColors) as [
              keyof typeof severityColors,
              (typeof severityColors)['critical'],
            ][]
          ).map(([severity, colors]) => (
            <g key={severity}>
              <path
                d={generatePath(severity)}
                fill="none"
                stroke={colors.stroke}
                strokeWidth={2}
                strokeLinecap="round"
                strokeLinejoin="round"
              />
              {/* Data points */}
              {displayData.map((d, i) => (
                <circle
                  key={i}
                  cx={xScale(i)}
                  cy={yScale(d.summary[severity])}
                  r={3}
                  fill={colors.stroke}
                  className="cursor-pointer hover:r-4"
                >
                  <title>
                    {formatDate(d.date)}: {d.summary[severity]} {severity}
                  </title>
                </circle>
              ))}
            </g>
          ))}

          {/* X axis labels */}
          {displayData.map((d, i) => {
            if (
              displayData.length <= 5 ||
              i === 0 ||
              i === displayData.length - 1 ||
              i === Math.floor(displayData.length / 2)
            ) {
              return (
                <text
                  key={i}
                  x={xScale(i)}
                  y={CHART_HEIGHT - 10}
                  textAnchor="middle"
                  className="text-xs fill-zinc-500 dark:fill-zinc-400"
                >
                  {formatDate(d.date)}
                </text>
              );
            }
            return null;
          })}
        </svg>
      </div>

      <p className={cn('text-xs mt-2 text-center', theme.text.subtle)}>
        {viewMode === 'stack'
          ? `Showing last ${displayData.length} scans`
          : `Showing ${displayData.length} scans for ${selectedImage}`}
      </p>
    </div>
  );
};
