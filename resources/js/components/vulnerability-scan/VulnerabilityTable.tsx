import React, { useState, useMemo } from 'react';
import { cn } from '../../utils/cn';
import { theme } from '../../theme';
import { ImageVulnerability, VulnerabilitySeverity } from '../../types/vulnerability';
import {
  ChevronDownIcon,
  ChevronUpIcon,
  MagnifyingGlassIcon,
  FunnelIcon,
} from '@heroicons/react/24/outline';

interface VulnerabilityTableProps {
  vulnerabilities: ImageVulnerability[];
  className?: string;
}

const severityOrder: Record<VulnerabilitySeverity, number> = {
  Critical: 0,
  High: 1,
  Medium: 2,
  Low: 3,
  Negligible: 4,
  Unknown: 5,
};

const severityConfig: Record<VulnerabilitySeverity, { color: string; bg: string }> = {
  Critical: {
    color: 'text-rose-600 dark:text-rose-400',
    bg: 'bg-rose-100 dark:bg-rose-900/30',
  },
  High: {
    color: 'text-orange-600 dark:text-orange-400',
    bg: 'bg-orange-100 dark:bg-orange-900/30',
  },
  Medium: {
    color: 'text-amber-600 dark:text-amber-400',
    bg: 'bg-amber-100 dark:bg-amber-900/30',
  },
  Low: {
    color: 'text-blue-600 dark:text-blue-400',
    bg: 'bg-blue-100 dark:bg-blue-900/30',
  },
  Negligible: {
    color: 'text-zinc-500 dark:text-zinc-400',
    bg: 'bg-zinc-100 dark:bg-zinc-800',
  },
  Unknown: {
    color: 'text-zinc-500 dark:text-zinc-400',
    bg: 'bg-zinc-100 dark:bg-zinc-800',
  },
};

type SortField = 'severity' | 'vulnerability_id' | 'package' | 'image_name';
type SortDirection = 'asc' | 'desc';

export const VulnerabilityTable: React.FC<VulnerabilityTableProps> = ({
  vulnerabilities,
  className,
}) => {
  const [search, setSearch] = useState('');
  const [sortField, setSortField] = useState<SortField>('severity');
  const [sortDirection, setSortDirection] = useState<SortDirection>('asc');
  const [severityFilter, setSeverityFilter] = useState<VulnerabilitySeverity | 'all'>('all');
  const [showFilters, setShowFilters] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const pageSize = 25;

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  const filteredAndSorted = useMemo(() => {
    let result = [...vulnerabilities];

    if (search) {
      const searchLower = search.toLowerCase();
      result = result.filter(
        (v) =>
          v.vulnerability_id.toLowerCase().includes(searchLower) ||
          v.package.toLowerCase().includes(searchLower) ||
          v.image_name.toLowerCase().includes(searchLower) ||
          v.description?.toLowerCase().includes(searchLower)
      );
    }

    if (severityFilter !== 'all') {
      result = result.filter((v) => v.severity === severityFilter);
    }

    result.sort((a, b) => {
      let comparison = 0;

      switch (sortField) {
        case 'severity':
          comparison = (severityOrder[a.severity] ?? 99) - (severityOrder[b.severity] ?? 99);
          break;
        case 'vulnerability_id':
          comparison = a.vulnerability_id.localeCompare(b.vulnerability_id);
          break;
        case 'package':
          comparison = a.package.localeCompare(b.package);
          break;
        case 'image_name':
          comparison = a.image_name.localeCompare(b.image_name);
          break;
      }

      return sortDirection === 'asc' ? comparison : -comparison;
    });

    return result;
  }, [vulnerabilities, search, severityFilter, sortField, sortDirection]);

  React.useEffect(() => {
    setCurrentPage(1);
  }, [search, severityFilter]);

  const totalPages = Math.ceil(filteredAndSorted.length / pageSize);
  const paginatedResults = useMemo(() => {
    const start = (currentPage - 1) * pageSize;
    return filteredAndSorted.slice(start, start + pageSize);
  }, [filteredAndSorted, currentPage, pageSize]);

  const renderSortIcon = (field: SortField) => {
    if (sortField !== field) return null;
    return sortDirection === 'asc' ? (
      <ChevronUpIcon className="w-4 h-4" />
    ) : (
      <ChevronDownIcon className="w-4 h-4" />
    );
  };

  if (vulnerabilities.length === 0) {
    return (
      <div className={cn('text-center py-8', className)}>
        <p className={cn('text-sm', theme.text.muted)}>No vulnerabilities found</p>
      </div>
    );
  }

  return (
    <div className={cn('space-y-4', className)}>
      {/* Search and Filters */}
      <div className="flex flex-col sm:flex-row gap-3">
        <div className="relative flex-1">
          <MagnifyingGlassIcon
            className={cn('absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4', theme.text.subtle)}
          />
          <input
            type="text"
            placeholder="Search vulnerabilities..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className={cn(
              'w-full pl-9 pr-4 py-2 rounded-lg text-sm',
              'border border-zinc-200 dark:border-zinc-700',
              'bg-white dark:bg-zinc-800',
              theme.text.standard,
              'placeholder:text-zinc-400 dark:placeholder:text-zinc-500',
              'focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent'
            )}
          />
        </div>
        <button
          onClick={() => setShowFilters(!showFilters)}
          className={cn(
            'flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium',
            'border border-zinc-200 dark:border-zinc-700',
            'bg-white dark:bg-zinc-800',
            theme.text.muted,
            'hover:bg-zinc-50 dark:hover:bg-zinc-700',
            showFilters && 'bg-zinc-100 dark:bg-zinc-700'
          )}
        >
          <FunnelIcon className="w-4 h-4" />
          Filters
          {severityFilter !== 'all' && (
            <span
              className={cn(
                'px-1.5 py-0.5 rounded text-xs',
                'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300'
              )}
            >
              1
            </span>
          )}
        </button>
      </div>

      {/* Filter Options */}
      {showFilters && (
        <div
          className={cn(
            'p-4 rounded-lg border',
            'border-zinc-200 dark:border-zinc-700',
            'bg-zinc-50 dark:bg-zinc-800/50'
          )}
        >
          <p className={cn('text-xs font-medium mb-2', theme.text.muted)}>Severity</p>
          <div className="flex flex-wrap gap-2">
            <FilterButton
              active={severityFilter === 'all'}
              onClick={() => setSeverityFilter('all')}
            >
              All
            </FilterButton>
            {(['Critical', 'High', 'Medium', 'Low', 'Negligible', 'Unknown'] as const).map(
              (sev) => (
                <FilterButton
                  key={sev}
                  active={severityFilter === sev}
                  onClick={() => setSeverityFilter(sev)}
                >
                  {sev}
                </FilterButton>
              )
            )}
          </div>
        </div>
      )}

      {/* Results count */}
      <p className={cn('text-xs', theme.text.subtle)}>
        Showing {(currentPage - 1) * pageSize + 1}-
        {Math.min(currentPage * pageSize, filteredAndSorted.length)} of {filteredAndSorted.length}{' '}
        vulnerabilities
        {filteredAndSorted.length !== vulnerabilities.length &&
          ` (${vulnerabilities.length} total)`}
      </p>

      {/* Table */}
      <div
        className={cn('rounded-lg border overflow-hidden', 'border-zinc-200 dark:border-zinc-800')}
      >
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr
                className={cn('border-b border-zinc-200 dark:border-zinc-800', theme.surface.muted)}
              >
                <SortableHeader field="severity" currentField={sortField} onClick={handleSort}>
                  Severity
                  {renderSortIcon('severity')}
                </SortableHeader>
                <SortableHeader
                  field="vulnerability_id"
                  currentField={sortField}
                  onClick={handleSort}
                >
                  CVE ID
                  {renderSortIcon('vulnerability_id')}
                </SortableHeader>
                <SortableHeader field="package" currentField={sortField} onClick={handleSort}>
                  Package
                  {renderSortIcon('package')}
                </SortableHeader>
                <SortableHeader field="image_name" currentField={sortField} onClick={handleSort}>
                  Image
                  {renderSortIcon('image_name')}
                </SortableHeader>
                <th className={cn('px-4 py-3 text-left font-medium', theme.text.muted)}>
                  Fixed In
                </th>
                <th className={cn('px-4 py-3 text-left font-medium', theme.text.muted)}>
                  Location
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-100 dark:divide-zinc-800">
              {paginatedResults.map((vuln) => {
                const config = severityConfig[vuln.severity] || severityConfig.Unknown;
                return (
                  <tr
                    key={vuln.id}
                    className="bg-white dark:bg-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800/50"
                  >
                    <td className="px-4 py-3">
                      <span
                        className={cn(
                          'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium',
                          config.bg,
                          config.color
                        )}
                      >
                        {vuln.severity}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      <a
                        href={`https://nvd.nist.gov/vuln/detail/${vuln.vulnerability_id}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className={cn(
                          'font-mono text-xs hover:underline',
                          'text-teal-600 dark:text-teal-400'
                        )}
                      >
                        {vuln.vulnerability_id}
                      </a>
                      {vuln.cvss && (
                        <span className={cn('ml-2 text-xs', theme.text.subtle)}>
                          CVSS: {vuln.cvss.toFixed(1)}
                        </span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      <div>
                        <p className={cn('font-medium', theme.text.strong)}>{vuln.package}</p>
                        <p className={cn('text-xs font-mono', theme.text.subtle)}>
                          {vuln.installed_version}
                        </p>
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <p
                        className={cn('font-mono text-xs truncate max-w-[200px]', theme.text.muted)}
                      >
                        {vuln.image_name}
                      </p>
                    </td>
                    <td className="px-4 py-3">
                      {vuln.fixed_version ? (
                        <span
                          className={cn(
                            'font-mono text-xs',
                            'text-emerald-600 dark:text-emerald-400'
                          )}
                        >
                          {vuln.fixed_version}
                        </span>
                      ) : (
                        <span className={cn('text-xs', theme.text.subtle)}>No fix available</span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {vuln.location ? (
                        <span
                          className={cn(
                            'font-mono text-xs truncate max-w-[200px] block',
                            theme.text.muted
                          )}
                          title={`${vuln.location}${vuln.layer_id ? `\nLayer: ${vuln.layer_id}` : ''}`}
                        >
                          {vuln.location}
                        </span>
                      ) : (
                        <span className={cn('text-xs', theme.text.subtle)}>-</span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex items-center justify-between">
          <p className={cn('text-xs', theme.text.subtle)}>
            Page {currentPage} of {totalPages}
          </p>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setCurrentPage(1)}
              disabled={currentPage === 1}
              className={cn(
                'px-2 py-1 text-xs rounded',
                'border border-zinc-200 dark:border-zinc-700',
                currentPage === 1
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-zinc-100 dark:hover:bg-zinc-700',
                theme.text.muted
              )}
            >
              First
            </button>
            <button
              onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
              disabled={currentPage === 1}
              className={cn(
                'px-3 py-1 text-xs rounded',
                'border border-zinc-200 dark:border-zinc-700',
                currentPage === 1
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-zinc-100 dark:hover:bg-zinc-700',
                theme.text.muted
              )}
            >
              Previous
            </button>
            <button
              onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
              disabled={currentPage === totalPages}
              className={cn(
                'px-3 py-1 text-xs rounded',
                'border border-zinc-200 dark:border-zinc-700',
                currentPage === totalPages
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-zinc-100 dark:hover:bg-zinc-700',
                theme.text.muted
              )}
            >
              Next
            </button>
            <button
              onClick={() => setCurrentPage(totalPages)}
              disabled={currentPage === totalPages}
              className={cn(
                'px-2 py-1 text-xs rounded',
                'border border-zinc-200 dark:border-zinc-700',
                currentPage === totalPages
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-zinc-100 dark:hover:bg-zinc-700',
                theme.text.muted
              )}
            >
              Last
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

const SortableHeader: React.FC<{
  field: SortField;
  currentField: SortField;
  onClick: (field: SortField) => void;
  children: React.ReactNode;
}> = ({ field, currentField, onClick, children }) => (
  <th
    className={cn(
      'px-4 py-3 text-left font-medium cursor-pointer select-none',
      'hover:bg-zinc-100 dark:hover:bg-zinc-700',
      currentField === field ? theme.text.strong : theme.text.muted
    )}
    onClick={() => onClick(field)}
  >
    <div className="flex items-center gap-1">{children}</div>
  </th>
);

const FilterButton: React.FC<{
  active: boolean;
  onClick: () => void;
  children: React.ReactNode;
}> = ({ active, onClick, children }) => (
  <button
    onClick={onClick}
    className={cn(
      'px-3 py-1.5 rounded-lg text-xs font-medium transition-colors',
      active
        ? 'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300'
        : 'bg-white dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700'
    )}
  >
    {children}
  </button>
);
