import React, { useEffect } from 'react';
import { cn } from '../../utils/cn';
import { theme } from '../../theme';
import {
  useLatestVulnerabilityScan,
  useStartVulnerabilityScan,
} from '../../hooks/useVulnerabilityScan';
import { VulnerabilitySummaryCard } from './VulnerabilitySummaryCard';
import { VulnerabilityTable } from './VulnerabilityTable';
import { LoadingSpinner } from '../common/LoadingSpinner';
import { EmptyState } from '../common/EmptyState';
import {
  ShieldCheckIcon,
  ShieldExclamationIcon,
  ArrowPathIcon,
  ClockIcon,
  ExclamationTriangleIcon,
} from '@heroicons/react/24/outline';
import { ScanStatus } from '../../types/vulnerability';

interface VulnerabilityScanPanelProps {
  serverid: number;
  stackname: string;
  canManage: boolean;
}

const statusConfig: Record<
  ScanStatus,
  { label: string; color: string; icon: React.ComponentType<{ className?: string }> }
> = {
  pending: {
    label: 'Pending',
    color: 'text-amber-600 dark:text-amber-400',
    icon: ClockIcon,
  },
  running: {
    label: 'Scanning',
    color: 'text-teal-600 dark:text-teal-400',
    icon: ArrowPathIcon,
  },
  completed: {
    label: 'Completed',
    color: 'text-emerald-600 dark:text-emerald-400',
    icon: ShieldCheckIcon,
  },
  failed: {
    label: 'Failed',
    color: 'text-rose-600 dark:text-rose-400',
    icon: ExclamationTriangleIcon,
  },
  timeout: {
    label: 'Timed Out',
    color: 'text-rose-600 dark:text-rose-400',
    icon: ClockIcon,
  },
};

export const VulnerabilityScanPanel: React.FC<VulnerabilityScanPanelProps> = ({
  serverid,
  stackname,
  canManage,
}) => {
  const { data, isLoading, error, refetch } = useLatestVulnerabilityScan({
    serverid,
    stackname,
    enabled: true,
  });

  const { mutate: startScan, isPending: isStarting } = useStartVulnerabilityScan({
    serverid,
    stackname,
    onSuccess: () => {
      refetch();
    },
  });

  const scan = data?.scan;
  const summary = data?.summary;
  const isScanning = scan?.status === 'pending' || scan?.status === 'running';

  useEffect(() => {
    if (!isScanning) return;

    const interval = setInterval(() => {
      refetch();
    }, 5000);

    return () => clearInterval(interval);
  }, [isScanning, refetch]);

  const handleStartScan = () => {
    startScan();
  };

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center">
        <LoadingSpinner size="lg" text="Loading scan data..." />
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-full flex items-center justify-center">
        <EmptyState
          icon={ExclamationTriangleIcon}
          title="Error loading scan data"
          description={error.message}
          variant="error"
          size="lg"
          action={{
            label: 'Try Again',
            onClick: () => refetch(),
          }}
        />
      </div>
    );
  }

  if (!scan) {
    return (
      <div className="h-full overflow-auto p-6">
        <div className="max-w-4xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h2 className={cn('text-xl font-bold', theme.text.strong)}>Security</h2>
              <p className={cn('text-sm', theme.text.subtle)}>
                Vulnerability scanning for container images
              </p>
            </div>
          </div>

          <EmptyState
            icon={ShieldExclamationIcon}
            title="No vulnerability scans"
            description="Run a vulnerability scan to check your container images for known security issues."
            variant="default"
            size="lg"
            action={
              canManage && !isStarting
                ? {
                    label: 'Start Scan',
                    onClick: handleStartScan,
                  }
                : undefined
            }
          />
        </div>
      </div>
    );
  }

  const statusInfo = statusConfig[scan.status];
  const StatusIcon = statusInfo.icon;

  return (
    <div className="h-full overflow-auto p-6">
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h2 className={cn('text-xl font-bold', theme.text.strong)}>Security</h2>
            <p className={cn('text-sm', theme.text.subtle)}>
              Vulnerability scanning for container images
            </p>
          </div>
          {canManage && (
            <button
              onClick={handleStartScan}
              disabled={isStarting || isScanning}
              className={cn(theme.buttons.primary, 'gap-2')}
            >
              {isStarting || isScanning ? (
                <>
                  <ArrowPathIcon className="w-4 h-4 animate-spin" />
                  {isStarting ? 'Starting...' : 'Scanning...'}
                </>
              ) : (
                <>
                  <ShieldExclamationIcon className="w-4 h-4" />
                  New Scan
                </>
              )}
            </button>
          )}
        </div>

        {/* Scan Status Card */}
        <div
          className={cn(
            'rounded-lg border p-4',
            'border-zinc-200 dark:border-zinc-800',
            'bg-white dark:bg-zinc-900'
          )}
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <StatusIcon
                className={cn('w-5 h-5', statusInfo.color, isScanning && 'animate-spin')}
              />
              <div>
                <p className={cn('font-medium', theme.text.strong)}>{statusInfo.label}</p>
                <p className={cn('text-xs', theme.text.subtle)}>
                  Started {new Date(scan.started_at).toLocaleString()}
                  {scan.completed_at && (
                    <> Â· Completed {new Date(scan.completed_at).toLocaleString()}</>
                  )}
                </p>
              </div>
            </div>

            {isScanning && (
              <div className="text-right">
                <p className={cn('text-sm font-medium tabular-nums', theme.text.strong)}>
                  {scan.scanned_images}/{scan.total_images}
                </p>
                <p className={cn('text-xs', theme.text.subtle)}>images scanned</p>
              </div>
            )}
          </div>

          {/* Progress bar for scanning */}
          {isScanning && scan.total_images > 0 && (
            <div className="mt-4">
              <div className="h-2 bg-zinc-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                <div
                  className="h-full bg-teal-500 dark:bg-teal-400 transition-all duration-300"
                  style={{
                    width: `${(scan.scanned_images / scan.total_images) * 100}%`,
                  }}
                />
              </div>
            </div>
          )}

          {/* Error message */}
          {scan.error_message && (
            <div
              className={cn(
                'mt-4 p-3 rounded-lg',
                'bg-rose-50 dark:bg-rose-900/20',
                'text-rose-700 dark:text-rose-300',
                'text-sm'
              )}
            >
              {scan.error_message}
            </div>
          )}
        </div>

        {/* Summary Card */}
        {scan.status === 'completed' && summary && <VulnerabilitySummaryCard summary={summary} />}

        {/* Vulnerability Table */}
        {scan.status === 'completed' && scan.vulnerabilities && scan.vulnerabilities.length > 0 && (
          <div
            className={cn(
              'rounded-lg border',
              'border-zinc-200 dark:border-zinc-800',
              'bg-white dark:bg-zinc-900'
            )}
          >
            <div
              className={cn(
                'px-4 py-3 border-b',
                'border-zinc-200 dark:border-zinc-800',
                theme.surface.muted
              )}
            >
              <h3 className={cn('text-sm font-semibold', theme.text.strong)}>Vulnerabilities</h3>
            </div>
            <div className="p-4">
              <VulnerabilityTable vulnerabilities={scan.vulnerabilities} />
            </div>
          </div>
        )}

        {/* No vulnerabilities found */}
        {scan.status === 'completed' &&
          (!scan.vulnerabilities || scan.vulnerabilities.length === 0) && (
            <EmptyState
              icon={ShieldCheckIcon}
              title="No vulnerabilities found"
              description="Your container images passed the security scan with no known vulnerabilities detected."
              variant="info"
              size="md"
            />
          )}
      </div>
    </div>
  );
};
