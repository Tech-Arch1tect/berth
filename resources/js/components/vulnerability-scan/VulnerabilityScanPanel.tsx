import { useEffect, useRef, useState } from 'react';
import { cn } from '../../utils/cn';
import { theme } from '../../theme';
import {
  useLatestVulnerabilityScan,
  useStartVulnerabilityScan,
  useVulnerabilityScanHistory,
  useVulnerabilityScan,
  useScanComparison,
  useScanTrend,
} from '../../hooks/useVulnerabilityScan';
import { VulnerabilitySummaryCard } from './VulnerabilitySummaryCard';
import { VulnerabilityTable } from './VulnerabilityTable';
import { VulnerabilityDetailPanel } from './VulnerabilityDetailPanel';
import { ScanHistoryList } from './ScanHistoryList';
import { ScanComparisonView } from './ScanComparisonView';
import { VulnerabilityTrendChart } from './VulnerabilityTrendChart';
import { ServiceSelectionModal } from './ServiceSelectionModal';
import { LoadingSpinner } from '../common/LoadingSpinner';
import { EmptyState } from '../common/EmptyState';
import {
  ShieldCheckIcon,
  ShieldExclamationIcon,
  ArrowPathIcon,
  ClockIcon,
  ExclamationTriangleIcon,
  ChevronDownIcon,
  ChevronUpIcon,
  ArrowsRightLeftIcon,
} from '@heroicons/react/24/outline';
import { ImageScan, ImageVulnerability, ScanStatus } from '../../types/vulnerability';

interface VulnerabilityScanPanelProps {
  serverid: number;
  stackname: string;
  canManage: boolean;
  services?: string[];
}

const statusConfig: Record<
  ScanStatus,
  { label: string; color: string; icon: React.ComponentType<{ className?: string }> }
> = {
  pending: {
    label: 'Pending',
    color: 'text-amber-600 dark:text-amber-400',
    icon: ClockIcon,
  },
  running: {
    label: 'Scanning',
    color: 'text-teal-600 dark:text-teal-400',
    icon: ArrowPathIcon,
  },
  completed: {
    label: 'Completed',
    color: 'text-emerald-600 dark:text-emerald-400',
    icon: ShieldCheckIcon,
  },
  failed: {
    label: 'Failed',
    color: 'text-rose-600 dark:text-rose-400',
    icon: ExclamationTriangleIcon,
  },
  timeout: {
    label: 'Timed Out',
    color: 'text-rose-600 dark:text-rose-400',
    icon: ClockIcon,
  },
};

export const VulnerabilityScanPanel: React.FC<VulnerabilityScanPanelProps> = ({
  serverid,
  stackname,
  canManage,
  services = [],
}) => {
  const [showHistory, setShowHistory] = useState(false);
  const [selectedHistoryScanId, setSelectedHistoryScanId] = useState<number | null>(null);
  const [compareScans, setCompareScans] = useState<number[]>([]);
  const [showComparison, setShowComparison] = useState(false);
  const [showServiceSelection, setShowServiceSelection] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<ImageVulnerability | null>(
    null
  );
  const comparisonRef = useRef<HTMLDivElement>(null);

  const { data, isLoading, error, refetch } = useLatestVulnerabilityScan({
    serverid,
    stackname,
    enabled: true,
  });

  const { data: historyData, isLoading: isHistoryLoading } = useVulnerabilityScanHistory({
    serverid,
    stackname,
    enabled: showHistory,
  });

  const { data: selectedHistoryScan } = useVulnerabilityScan({
    scanid: selectedHistoryScanId ?? 0,
    enabled: !!selectedHistoryScanId,
  });

  const { data: comparisonData, isLoading: isComparisonLoading } = useScanComparison({
    baseScanId: compareScans[0] || 0,
    compareScanId: compareScans[1] || 0,
    enabled: showComparison && compareScans.length === 2,
  });

  const { data: trendData } = useScanTrend({
    serverid,
    stackname,
    limit: 10,
    enabled: true,
  });

  const { mutate: startScan, isPending: isStarting } = useStartVulnerabilityScan({
    serverid,
    stackname,
    onSuccess: () => {
      refetch();
      setSelectedHistoryScanId(null);
    },
  });

  const latestScan = data?.scan;
  const latestSummary = data?.summary;

  const scan = selectedHistoryScanId && selectedHistoryScan ? selectedHistoryScan : latestScan;
  const summary = selectedHistoryScanId ? undefined : latestSummary;
  const isScanning = latestScan?.status === 'pending' || latestScan?.status === 'running';
  const isViewingHistory = !!selectedHistoryScanId;

  const handleSelectHistoryScan = (historyScan: ImageScan) => {
    if (selectedHistoryScanId === historyScan.id) {
      setSelectedHistoryScanId(null);
    } else {
      setSelectedHistoryScanId(historyScan.id);
    }
    setSelectedVulnerability(null);
  };

  const handleToggleCompare = (scanId: number) => {
    setCompareScans((prev) => {
      if (prev.includes(scanId)) {
        return prev.filter((id) => id !== scanId);
      }
      if (prev.length >= 2) {
        return [prev[1], scanId];
      }
      return [...prev, scanId];
    });
  };

  const handleCompare = () => {
    if (compareScans.length === 2) {
      setShowComparison(true);
    }
  };

  const handleCloseComparison = () => {
    setShowComparison(false);
  };

  useEffect(() => {
    if (!isScanning) return;

    const interval = setInterval(() => {
      refetch();
    }, 5000);

    return () => clearInterval(interval);
  }, [isScanning, refetch]);

  useEffect(() => {
    if (showComparison && comparisonData && comparisonRef.current) {
      comparisonRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, [showComparison, comparisonData]);

  const handleNewScanClick = () => {
    if (services.length > 0) {
      setShowServiceSelection(true);
    } else {
      startScan();
    }
  };

  const handleScanAll = () => {
    setShowServiceSelection(false);
    startScan();
  };

  const handleScanSelected = (selectedServices: string[]) => {
    setShowServiceSelection(false);
    startScan({ services: selectedServices });
  };

  const handleCloseServiceSelection = () => {
    setShowServiceSelection(false);
  };

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center">
        <LoadingSpinner size="lg" text="Loading scan data..." />
      </div>
    );
  }

  const isNoScansError =
    error &&
    'response' in error &&
    (error as { response?: { status?: number } }).response?.status === 404;

  if (error && !isNoScansError) {
    return (
      <div className="h-full flex items-center justify-center">
        <EmptyState
          icon={ExclamationTriangleIcon}
          title="Error loading scan data"
          description={error.message}
          variant="error"
          size="lg"
          action={{
            label: 'Try Again',
            onClick: () => refetch(),
          }}
        />
      </div>
    );
  }

  if (!scan) {
    return (
      <div className="h-full overflow-auto p-6">
        <div className="max-w-4xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h2 className={cn('text-xl font-bold', theme.text.strong)}>Security</h2>
              <p className={cn('text-sm', theme.text.subtle)}>
                Vulnerability scanning for container images
              </p>
            </div>
          </div>

          <EmptyState
            icon={ShieldExclamationIcon}
            title="No vulnerability scans"
            description="Run a vulnerability scan to check your container images for known security issues."
            variant="default"
            size="lg"
            action={
              canManage && !isStarting
                ? {
                    label: 'Start Scan',
                    onClick: handleNewScanClick,
                  }
                : undefined
            }
          />

          {/* Service Selection Modal */}
          <ServiceSelectionModal
            services={services}
            isOpen={showServiceSelection}
            onClose={handleCloseServiceSelection}
            onScanAll={handleScanAll}
            onScanSelected={handleScanSelected}
            isStarting={isStarting}
          />
        </div>
      </div>
    );
  }

  const statusInfo = statusConfig[scan.status as ScanStatus];
  const StatusIcon = statusInfo.icon;

  const showDetailPanel = selectedVulnerability !== null;

  return (
    <div className="h-full flex">
      {/* Main Content */}
      <div
        className={cn('flex-1 overflow-auto p-6', showDetailPanel && 'max-w-[calc(100%-400px)]')}
      >
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h2 className={cn('text-xl font-bold', theme.text.strong)}>Security</h2>
              <p className={cn('text-sm', theme.text.subtle)}>
                Vulnerability scanning for container images
              </p>
            </div>
            {canManage && (
              <button
                onClick={handleNewScanClick}
                disabled={isStarting || isScanning}
                className={cn(theme.buttons.primary, 'gap-2')}
              >
                {isStarting || isScanning ? (
                  <>
                    <ArrowPathIcon className="w-4 h-4 animate-spin" />
                    {isStarting ? 'Starting...' : 'Scanning...'}
                  </>
                ) : (
                  <>
                    <ShieldExclamationIcon className="w-4 h-4" />
                    New Scan
                  </>
                )}
              </button>
            )}
          </div>

          {/* Service Selection Modal */}
          <ServiceSelectionModal
            services={services}
            isOpen={showServiceSelection}
            onClose={handleCloseServiceSelection}
            onScanAll={handleScanAll}
            onScanSelected={handleScanSelected}
            isStarting={isStarting}
          />

          {/* Viewing Historical Scan Banner */}
          {isViewingHistory && (
            <div
              className={cn(
                'flex items-center justify-between p-3 rounded-lg',
                'bg-amber-50 dark:bg-amber-900/20',
                'border border-amber-200 dark:border-amber-800'
              )}
            >
              <p className="text-sm text-amber-700 dark:text-amber-300">
                Viewing historical scan from {new Date(scan.started_at).toLocaleDateString()}
              </p>
              <button
                onClick={() => setSelectedHistoryScanId(null)}
                className={cn(
                  'text-sm font-medium px-3 py-1 rounded',
                  'text-amber-700 dark:text-amber-300',
                  'hover:bg-amber-100 dark:hover:bg-amber-900/40'
                )}
              >
                View Latest
              </button>
            </div>
          )}

          {/* Scan Status Card */}
          <div
            className={cn(
              'rounded-lg border p-4',
              'border-zinc-200 dark:border-zinc-800',
              'bg-white dark:bg-zinc-900'
            )}
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <StatusIcon
                  className={cn('w-5 h-5', statusInfo.color, isScanning && 'animate-spin')}
                />
                <div>
                  <p className={cn('font-medium', theme.text.strong)}>{statusInfo.label}</p>
                  <p className={cn('text-xs', theme.text.subtle)}>
                    Started {new Date(scan.started_at).toLocaleString()}
                    {scan.completed_at && (
                      <> Â· Completed {new Date(scan.completed_at).toLocaleString()}</>
                    )}
                  </p>
                </div>
              </div>

              {isScanning && (
                <div className="text-right">
                  <p className={cn('text-sm font-medium tabular-nums', theme.text.strong)}>
                    {scan.scanned_images}/{scan.total_images}
                  </p>
                  <p className={cn('text-xs', theme.text.subtle)}>images scanned</p>
                </div>
              )}
            </div>

            {/* Progress bar for scanning */}
            {isScanning && scan.total_images > 0 && (
              <div className="mt-4">
                <div className="h-2 bg-zinc-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-teal-500 dark:bg-teal-400 transition-all duration-300"
                    style={{
                      width: `${(scan.scanned_images / scan.total_images) * 100}%`,
                    }}
                  />
                </div>
              </div>
            )}

            {/* Error message */}
            {scan.error_message && (
              <div
                className={cn(
                  'mt-4 p-3 rounded-lg',
                  'bg-rose-50 dark:bg-rose-900/20',
                  'text-rose-700 dark:text-rose-300',
                  'text-sm'
                )}
              >
                {scan.error_message}
              </div>
            )}
          </div>

          {/* Summary Card */}
          {scan.status === 'completed' && summary && <VulnerabilitySummaryCard summary={summary} />}

          {/* Trend Chart */}
          {!isViewingHistory && trendData && trendData.stack_trend.length >= 2 && (
            <VulnerabilityTrendChart
              stackTrend={trendData.stack_trend}
              perImageTrend={trendData.per_image_trend}
              scopeWarning={trendData.scope_warning}
            />
          )}

          {/* Scan Comparison View */}
          {showComparison && (comparisonData || isComparisonLoading) && (
            <div ref={comparisonRef}>
              <ScanComparisonView
                comparison={comparisonData!}
                isLoading={isComparisonLoading}
                onClose={handleCloseComparison}
              />
            </div>
          )}

          {/* Vulnerability Table */}
          {scan.status === 'completed' &&
            scan.vulnerabilities &&
            scan.vulnerabilities.length > 0 && (
              <div
                className={cn(
                  'rounded-lg border',
                  'border-zinc-200 dark:border-zinc-800',
                  'bg-white dark:bg-zinc-900'
                )}
              >
                <div
                  className={cn(
                    'px-4 py-3 border-b',
                    'border-zinc-200 dark:border-zinc-800',
                    theme.surface.muted
                  )}
                >
                  <h3 className={cn('text-sm font-semibold', theme.text.strong)}>
                    Vulnerabilities
                  </h3>
                </div>
                <div className="p-4">
                  <VulnerabilityTable
                    vulnerabilities={scan.vulnerabilities}
                    selectedId={selectedVulnerability?.id}
                    onSelect={setSelectedVulnerability}
                  />
                </div>
              </div>
            )}

          {/* No vulnerabilities found */}
          {scan.status === 'completed' &&
            (!scan.vulnerabilities || scan.vulnerabilities.length === 0) && (
              <EmptyState
                icon={ShieldCheckIcon}
                title="No vulnerabilities found"
                description="Your container images passed the security scan with no known vulnerabilities detected."
                variant="info"
                size="md"
              />
            )}

          {/* Scan History Section */}
          <div
            className={cn(
              'rounded-lg border',
              'border-zinc-200 dark:border-zinc-800',
              'bg-white dark:bg-zinc-900'
            )}
          >
            <button
              onClick={() => setShowHistory(!showHistory)}
              className={cn(
                'w-full flex items-center justify-between px-4 py-3',
                'hover:bg-zinc-50 dark:hover:bg-zinc-800/50',
                'transition-colors'
              )}
            >
              <div className="flex items-center gap-2">
                <ClockIcon className={cn('w-5 h-5', theme.text.muted)} />
                <h3 className={cn('text-sm font-semibold', theme.text.strong)}>Scan History</h3>
              </div>
              <div className="flex items-center gap-2">
                {compareScans.length === 2 && (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleCompare();
                    }}
                    className={cn(
                      'flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium',
                      'bg-teal-100 dark:bg-teal-900/30',
                      'text-teal-700 dark:text-teal-300',
                      'hover:bg-teal-200 dark:hover:bg-teal-900/50'
                    )}
                  >
                    <ArrowsRightLeftIcon className="w-4 h-4" />
                    Compare
                  </button>
                )}
                {showHistory ? (
                  <ChevronUpIcon className={cn('w-5 h-5', theme.text.muted)} />
                ) : (
                  <ChevronDownIcon className={cn('w-5 h-5', theme.text.muted)} />
                )}
              </div>
            </button>

            {showHistory && (
              <div className={cn('px-4 pb-4 border-t', 'border-zinc-200 dark:border-zinc-800')}>
                {isHistoryLoading ? (
                  <div className="py-6 flex justify-center">
                    <LoadingSpinner size="md" text="Loading history..." />
                  </div>
                ) : (
                  <div className="pt-3">
                    {compareScans.length > 0 && (
                      <p className={cn('text-xs mb-2', theme.text.subtle)}>
                        Select 2 scans to compare ({compareScans.length}/2 selected)
                      </p>
                    )}
                    <ScanHistoryList
                      scans={historyData || []}
                      selectedScanId={selectedHistoryScanId ?? undefined}
                      onSelectScan={handleSelectHistoryScan}
                      compareScans={compareScans}
                      onToggleCompare={handleToggleCompare}
                    />
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Vulnerability Detail Panel */}
      {showDetailPanel && (
        <div className="w-[400px] flex-shrink-0 h-full overflow-hidden">
          <VulnerabilityDetailPanel
            vulnerability={selectedVulnerability}
            onClose={() => setSelectedVulnerability(null)}
          />
        </div>
      )}
    </div>
  );
};
