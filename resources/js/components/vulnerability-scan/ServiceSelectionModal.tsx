import { useState } from 'react';
import { cn } from '../../utils/cn';
import { theme } from '../../theme';
import { XMarkIcon, ShieldExclamationIcon, CheckIcon, CubeIcon } from '@heroicons/react/24/outline';

interface ServiceSelectionModalProps {
  services: string[];
  isOpen: boolean;
  onClose: () => void;
  onScanAll: () => void;
  onScanSelected: (selectedServices: string[]) => void;
  isStarting: boolean;
}

export const ServiceSelectionModal: React.FC<ServiceSelectionModalProps> = ({
  services,
  isOpen,
  onClose,
  onScanAll,
  onScanSelected,
  isStarting,
}) => {
  const [selectedServices, setSelectedServices] = useState<string[]>([]);

  if (!isOpen) return null;

  const handleToggleService = (service: string) => {
    setSelectedServices((prev) =>
      prev.includes(service) ? prev.filter((s) => s !== service) : [...prev, service]
    );
  };

  const handleSelectAll = () => {
    setSelectedServices([...services]);
  };

  const handleDeselectAll = () => {
    setSelectedServices([]);
  };

  const handleScanSelected = () => {
    if (selectedServices.length > 0) {
      onScanSelected(selectedServices);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose} />

      {/* Modal */}
      <div
        className={cn(
          'relative w-full max-w-lg mx-4 rounded-lg shadow-xl',
          'bg-white dark:bg-zinc-900',
          'border border-zinc-200 dark:border-zinc-800'
        )}
      >
        {/* Header */}
        <div
          className={cn(
            'flex items-center justify-between px-4 py-3 border-b',
            'border-zinc-200 dark:border-zinc-800'
          )}
        >
          <div className="flex items-center gap-2">
            <ShieldExclamationIcon className={cn('w-5 h-5', theme.text.muted)} />
            <h3 className={cn('text-base font-semibold', theme.text.strong)}>
              Start Vulnerability Scan
            </h3>
          </div>
          <button
            onClick={onClose}
            disabled={isStarting}
            className={cn(
              'p-1.5 rounded-lg transition-colors',
              'hover:bg-zinc-100 dark:hover:bg-zinc-800',
              theme.text.muted
            )}
          >
            <XMarkIcon className="w-5 h-5" />
          </button>
        </div>

        {/* Content */}
        <div className="p-4">
          <p className={cn('text-sm mb-4', theme.text.muted)}>
            Select which services to scan, or scan all services in the stack.
          </p>

          {/* Quick actions */}
          <div className="flex items-center gap-2 mb-3">
            <button
              onClick={handleSelectAll}
              disabled={isStarting}
              className={cn(
                'text-xs px-2 py-1 rounded',
                'text-teal-600 dark:text-teal-400',
                'hover:bg-teal-50 dark:hover:bg-teal-900/20'
              )}
            >
              Select All
            </button>
            <button
              onClick={handleDeselectAll}
              disabled={isStarting}
              className={cn(
                'text-xs px-2 py-1 rounded',
                theme.text.muted,
                'hover:bg-zinc-100 dark:hover:bg-zinc-800'
              )}
            >
              Deselect All
            </button>
            <span className={cn('text-xs ml-auto', theme.text.subtle)}>
              {selectedServices.length} of {services.length} selected
            </span>
          </div>

          {/* Service list */}
          <div
            className={cn(
              'max-h-64 overflow-y-auto rounded-lg border',
              'border-zinc-200 dark:border-zinc-700'
            )}
          >
            {services.map((service) => {
              const isSelected = selectedServices.includes(service);
              return (
                <button
                  key={service}
                  onClick={() => handleToggleService(service)}
                  disabled={isStarting}
                  className={cn(
                    'w-full flex items-center gap-3 px-3 py-2 text-left',
                    'border-b last:border-b-0 border-zinc-200 dark:border-zinc-700',
                    'hover:bg-zinc-50 dark:hover:bg-zinc-800/50',
                    'transition-colors',
                    isSelected && 'bg-teal-50 dark:bg-teal-900/20'
                  )}
                >
                  <div
                    className={cn(
                      'w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0',
                      'transition-colors',
                      isSelected
                        ? 'bg-teal-500 border-teal-500'
                        : 'border-zinc-300 dark:border-zinc-600'
                    )}
                  >
                    {isSelected && <CheckIcon className="w-3 h-3 text-white" />}
                  </div>
                  <CubeIcon className={cn('w-4 h-4 flex-shrink-0', theme.text.subtle)} />
                  <span
                    className={cn(
                      'text-sm truncate',
                      isSelected ? theme.text.strong : theme.text.muted
                    )}
                  >
                    {service}
                  </span>
                </button>
              );
            })}
          </div>
        </div>

        {/* Footer */}
        <div
          className={cn(
            'flex items-center justify-end gap-3 px-4 py-3 border-t',
            'border-zinc-200 dark:border-zinc-800',
            'bg-zinc-50 dark:bg-zinc-800/50'
          )}
        >
          <button onClick={onClose} disabled={isStarting} className={cn(theme.buttons.secondary)}>
            Cancel
          </button>
          <button
            onClick={handleScanSelected}
            disabled={isStarting || selectedServices.length === 0}
            className={cn(theme.buttons.secondary)}
          >
            Scan Selected ({selectedServices.length})
          </button>
          <button onClick={onScanAll} disabled={isStarting} className={cn(theme.buttons.primary)}>
            Scan All
          </button>
        </div>
      </div>
    </div>
  );
};
