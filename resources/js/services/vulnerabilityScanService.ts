import axios from 'axios';
import {
  ImageScan,
  VulnerabilitySummary,
  LatestScanResponse,
  ScansHistoryResponse,
  ScanWithSummary,
  ScanComparison,
  ScanTrendPoint,
  ScanTrendResponse,
} from '../types/vulnerability';

const api = axios.create({
  headers: {
    'Content-Type': 'application/json',
    'X-Requested-With': 'XMLHttpRequest',
  },
});

export class VulnerabilityScanService {
  static async startScan(
    serverid: number,
    stackname: string,
    csrfToken?: string
  ): Promise<ImageScan> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.post<ImageScan>(
        `/api/v1/servers/${serverid}/stacks/${stackname}/vulnscan`,
        {},
        { headers }
      );
      return response.data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to scan this stack');
        }
        if (error.response?.status === 404) {
          throw new Error('Stack not found');
        }
        throw new Error(error.response?.data?.error || 'Failed to start vulnerability scan');
      }
      throw new Error('Network error occurred');
    }
  }

  static async getLatestScan(
    serverid: number,
    stackname: string,
    csrfToken?: string
  ): Promise<LatestScanResponse> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.get<LatestScanResponse>(
        `/api/v1/servers/${serverid}/stacks/${stackname}/vulnscan`,
        { headers }
      );
      return response.data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to view scans for this stack');
        }
        if (error.response?.status === 404) {
          return {
            scan: null as unknown as ImageScan,
            summary: null as unknown as VulnerabilitySummary,
          };
        }
        throw new Error(error.response?.data?.error || 'Failed to fetch latest scan');
      }
      throw new Error('Network error occurred');
    }
  }

  static async getScanHistory(
    serverid: number,
    stackname: string,
    csrfToken?: string
  ): Promise<ScanWithSummary[]> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.get<ScansHistoryResponse>(
        `/api/v1/servers/${serverid}/stacks/${stackname}/vulnscan/history`,
        { headers }
      );
      return response.data.scans || [];
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to view scan history');
        }
        if (error.response?.status === 404) {
          return [];
        }
        throw new Error(error.response?.data?.error || 'Failed to fetch scan history');
      }
      throw new Error('Network error occurred');
    }
  }

  static async getScan(scanid: number, csrfToken?: string): Promise<ImageScan> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.get<ImageScan>(`/api/v1/vulnscan/${scanid}`, { headers });
      return response.data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to view this scan');
        }
        if (error.response?.status === 404) {
          throw new Error('Scan not found');
        }
        throw new Error(error.response?.data?.error || 'Failed to fetch scan');
      }
      throw new Error('Network error occurred');
    }
  }

  static async getScanSummary(scanid: number, csrfToken?: string): Promise<VulnerabilitySummary> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.get<VulnerabilitySummary>(`/api/v1/vulnscan/${scanid}/summary`, {
        headers,
      });
      return response.data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to view this scan summary');
        }
        if (error.response?.status === 404) {
          throw new Error('Scan not found');
        }
        throw new Error(error.response?.data?.error || 'Failed to fetch scan summary');
      }
      throw new Error('Network error occurred');
    }
  }

  static async compareScans(
    baseScanId: number,
    compareScanId: number,
    csrfToken?: string
  ): Promise<ScanComparison> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const response = await api.get<ScanComparison>(
        `/api/v1/vulnscan/compare/${baseScanId}/${compareScanId}`,
        { headers }
      );
      return response.data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to compare these scans');
        }
        if (error.response?.status === 404) {
          throw new Error('One or both scans not found');
        }
        throw new Error(error.response?.data?.error || 'Failed to compare scans');
      }
      throw new Error('Network error occurred');
    }
  }

  static async getScanTrend(
    serverid: number,
    stackname: string,
    limit?: number,
    csrfToken?: string
  ): Promise<ScanTrendPoint[]> {
    try {
      const headers: Record<string, string> = {};
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }

      const params = limit ? { limit: limit.toString() } : undefined;
      const response = await api.get<ScanTrendResponse>(
        `/api/v1/servers/${serverid}/stacks/${stackname}/vulnscan/trend`,
        { headers, params }
      );
      return response.data.trend || [];
    } catch (error) {
      if (axios.isAxiosError(error)) {
        if (error.response?.status === 403) {
          throw new Error('You do not have permission to view scan trends');
        }
        if (error.response?.status === 404) {
          return [];
        }
        throw new Error(error.response?.data?.error || 'Failed to fetch scan trend');
      }
      throw new Error('Network error occurred');
    }
  }
}
