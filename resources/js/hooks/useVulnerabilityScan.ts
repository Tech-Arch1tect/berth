import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import {
  getApiV1ServersServeridStacksStacknameVulnscan,
  postApiV1ServersServeridStacksStacknameVulnscan,
  getApiV1ServersServeridStacksStacknameVulnscanHistory,
  getApiV1ServersServeridStacksStacknameVulnscanTrend,
  getApiV1VulnscanScanid,
  getApiV1VulnscanScanidSummary,
  getApiV1VulnscanCompareBaseScanIdCompareScanId,
} from '../api/generated/vulnscan/vulnscan';
import type {
  ImageScan,
  VulnerabilitySummary,
  ScanWithSummary,
  ScanComparison,
  GetLatestScanData,
  GetScanTrendData,
} from '../api/generated/models';

interface UseLatestVulnerabilityScanOptions {
  serverid: number;
  stackname: string;
  enabled?: boolean;
}

export function useLatestVulnerabilityScan({
  serverid,
  stackname,
  enabled = true,
}: UseLatestVulnerabilityScanOptions) {
  return useQuery<GetLatestScanData, Error>({
    queryKey: ['vulnerability-scan', 'latest', serverid, stackname],
    queryFn: async () => {
      const response = await getApiV1ServersServeridStacksStacknameVulnscan(serverid, stackname);
      return response.data.data;
    },
    enabled: enabled && !!serverid && !!stackname,
    staleTime: 30 * 1000,
    gcTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}

interface UseVulnerabilityScanHistoryOptions {
  serverid: number;
  stackname: string;
  enabled?: boolean;
}

export function useVulnerabilityScanHistory({
  serverid,
  stackname,
  enabled = true,
}: UseVulnerabilityScanHistoryOptions) {
  return useQuery<ScanWithSummary[], Error>({
    queryKey: ['vulnerability-scan', 'history', serverid, stackname],
    queryFn: async () => {
      const response = await getApiV1ServersServeridStacksStacknameVulnscanHistory(
        serverid,
        stackname
      );
      return response.data.data.scans;
    },
    enabled: enabled && !!serverid && !!stackname,
    staleTime: 30 * 1000,
    gcTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}

interface UseVulnerabilityScanOptions {
  scanid: number;
  enabled?: boolean;
}

export function useVulnerabilityScan({ scanid, enabled = true }: UseVulnerabilityScanOptions) {
  return useQuery<ImageScan, Error>({
    queryKey: ['vulnerability-scan', scanid],
    queryFn: async () => {
      const response = await getApiV1VulnscanScanid(scanid);
      return response.data.data.scan;
    },
    enabled: enabled && !!scanid,
    staleTime: 30 * 1000,
    gcTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}

interface UseVulnerabilityScanSummaryOptions {
  scanid: number;
  enabled?: boolean;
}

export function useVulnerabilityScanSummary({
  scanid,
  enabled = true,
}: UseVulnerabilityScanSummaryOptions) {
  return useQuery<VulnerabilitySummary, Error>({
    queryKey: ['vulnerability-scan', 'summary', scanid],
    queryFn: async () => {
      const response = await getApiV1VulnscanScanidSummary(scanid);
      return response.data.data.summary;
    },
    enabled: enabled && !!scanid,
    staleTime: 30 * 1000,
    gcTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}

interface UseStartVulnerabilityScanOptions {
  serverid: number;
  stackname: string;
  onSuccess?: (scan: ImageScan) => void;
  onError?: (error: Error) => void;
}

interface StartScanVariables {
  services?: string[];
}

export function useStartVulnerabilityScan({
  serverid,
  stackname,
  onSuccess,
  onError,
}: UseStartVulnerabilityScanOptions) {
  const queryClient = useQueryClient();

  return useMutation<ImageScan, Error, StartScanVariables | void>({
    mutationFn: async (variables) => {
      const services = variables?.services;
      const body = services && services.length > 0 ? { services } : {};
      const response = await postApiV1ServersServeridStacksStacknameVulnscan(
        serverid,
        stackname,
        body
      );
      return response.data.data.scan;
    },
    onSuccess: (scan) => {
      queryClient.invalidateQueries({
        queryKey: ['vulnerability-scan', 'latest', serverid, stackname],
      });
      queryClient.invalidateQueries({
        queryKey: ['vulnerability-scan', 'history', serverid, stackname],
      });
      onSuccess?.(scan);
    },
    onError: (error) => {
      onError?.(error);
    },
  });
}

interface UseScanComparisonOptions {
  baseScanId: number;
  compareScanId: number;
  enabled?: boolean;
}

export function useScanComparison({
  baseScanId,
  compareScanId,
  enabled = true,
}: UseScanComparisonOptions) {
  return useQuery<ScanComparison, Error>({
    queryKey: ['vulnerability-scan', 'compare', baseScanId, compareScanId],
    queryFn: async () => {
      const response = await getApiV1VulnscanCompareBaseScanIdCompareScanId(
        baseScanId,
        compareScanId
      );
      return response.data.data.comparison;
    },
    enabled: enabled && !!baseScanId && !!compareScanId,
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
  });
}

interface UseScanTrendOptions {
  serverid: number;
  stackname: string;
  limit?: number;
  enabled?: boolean;
}

export function useScanTrend({
  serverid,
  stackname,
  limit = 10,
  enabled = true,
}: UseScanTrendOptions) {
  return useQuery<GetScanTrendData, Error>({
    queryKey: ['vulnerability-scan', 'trend', serverid, stackname, limit],
    queryFn: async () => {
      const response = await getApiV1ServersServeridStacksStacknameVulnscanTrend(
        serverid,
        stackname,
        { limit }
      );
      return response.data.data;
    },
    enabled: enabled && !!serverid && !!stackname,
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
    retry: 1,
  });
}
